<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-additional_features/background_manager" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.0">
<title data-rh="true">Background Service: Background Job Processing | Flutter Tether</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://flutterTether.github.io/flutter_tether/img/ft-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://flutterTether.github.io/flutter_tether/img/ft-social-card.jpg"><meta data-rh="true" property="og:url" content="https://flutterTether.github.io/flutter_tether/additional_features/background_manager"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Background Service: Background Job Processing | Flutter Tether"><meta data-rh="true" name="description" content="The Background Service unit provides a robust system for executing tasks in a"><meta data-rh="true" property="og:description" content="The Background Service unit provides a robust system for executing tasks in a"><link data-rh="true" rel="icon" href="/flutter_tether/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://flutterTether.github.io/flutter_tether/additional_features/background_manager"><link data-rh="true" rel="alternate" href="https://flutterTether.github.io/flutter_tether/additional_features/background_manager" hreflang="en"><link data-rh="true" rel="alternate" href="https://flutterTether.github.io/flutter_tether/additional_features/background_manager" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Additional Features","item":"https://flutterTether.github.io/flutter_tether/category/additional-features"},{"@type":"ListItem","position":2,"name":"Background Service: Background Job Processing","item":"https://flutterTether.github.io/flutter_tether/additional_features/background_manager"}]}</script><link rel="stylesheet" href="/flutter_tether/assets/css/styles.0f514b2e.css">
<script src="/flutter_tether/assets/js/runtime~main.7e6783ff.js" defer="defer"></script>
<script src="/flutter_tether/assets/js/main.c4f0b1ee.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/flutter_tether/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/flutter_tether/"><div class="navbar__logo"><img src="/flutter_tether/img/logo.svg" alt="Flutter Tether Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/flutter_tether/img/logo.svg" alt="Flutter Tether Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Flutter Tether</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/flutter_tether/intro">Documentation</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/cspecter/flutter_tether" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/flutter_tether/intro">About Tether</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/flutter_tether/schema">Schema Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/flutter_tether/models">Models</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/flutter_tether/select_builders">Select Builders</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/flutter_tether/managers">Managers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/flutter_tether/full_text_search">Full Text Search</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/flutter_tether/config">Configuration Reference</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/flutter_tether/category/additional-features">Additional Features</a><button aria-label="Collapse sidebar category &#x27;Additional Features&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/flutter_tether/additional_features/feed_provider">Feed Management System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/flutter_tether/additional_features/auth_manager">Auth Manager</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/flutter_tether/additional_features/user_preferences_manager">User Preferences Manager</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/flutter_tether/additional_features/background_manager">Background Service: Background Job Processing</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/flutter_tether/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/flutter_tether/category/additional-features"><span>Additional Features</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Background Service: Background Job Processing</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Background Service: Background Job Processing</h1></header>
<p>The Background Service unit provides a robust system for executing tasks in a
separate isolate on mobile devices, ensuring operations can continue even when
the app is not in the foreground. It leverages <code>flutter_background_service</code> and
integrates with a local SQLite database for persistent job queuing and
management.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>The system comprises several key components:</p>
<ul>
<li><strong><code>BackgroundService</code> (<code>tether_libs</code>)</strong>: The core class responsible for
initializing and managing the background isolate, registering job handlers,
and enqueuing jobs.</li>
<li><strong><code>BackgroundJobManager</code> (<code>tether_libs</code>)</strong>: A manager class for the UI isolate
to interact with the <code>background_service_jobs</code> SQLite table (e.g., querying
job status, enqueuing jobs).</li>
<li><strong>Job Handlers</strong>: Functions you define that execute specific tasks in the
background isolate.</li>
<li><strong><code>background_service_jobs</code> Table</strong>: An SQLite table that stores job details,
status, and metadata.</li>
<li><strong>Riverpod Providers</strong>: For easy integration and state management in the UI.</li>
</ul>
<p>Key features include:</p>
<ul>
<li><strong>Persistent Job Queue</strong>: Jobs are stored in SQLite and survive app restarts.</li>
<li><strong>Isolate-Based Execution</strong>: Tasks run in a separate Dart isolate, preventing
UI freezes.</li>
<li><strong>Type-Safe Payloads</strong>: Job data is typically handled as
<code>Map&lt;String, dynamic&gt;</code>, often JSON-encoded.</li>
<li><strong>Status Tracking</strong>: Jobs progress through states like <code>PENDING</code>, <code>RUNNING</code>,
<code>COMPLETED</code>, <code>FAILED</code>.</li>
<li><strong>Retry Logic</strong>: Automatic retries for failed jobs, configurable per job.</li>
<li><strong>Priority Support</strong>: Influence the order of job execution.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="setup--configuration">Setup &amp; Configuration<a href="#setup--configuration" class="hash-link" aria-label="Direct link to Setup &amp; Configuration" title="Direct link to Setup &amp; Configuration">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-enable-in-configuration-tetheryaml">1. Enable in Configuration (<code>tether.yaml</code>)<a href="#1-enable-in-configuration-tetheryaml" class="hash-link" aria-label="Direct link to 1-enable-in-configuration-tetheryaml" title="Direct link to 1-enable-in-configuration-tetheryaml">​</a></h3>
<p>Ensure background services are enabled in your <code>tether.yaml</code> (if applicable to
your Tether version for auto-generation of related components):</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">generation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">background_services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Or similar configuration</span><br></span></code></pre></div></div>
<p><em>Tether typically generates the <code>background_service_jobs</code> table migration and a
provider for <code>BackgroundJobManager</code>.</em></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-install-dependencies">2. Install Dependencies<a href="#2-install-dependencies" class="hash-link" aria-label="Direct link to 2. Install Dependencies" title="Direct link to 2. Install Dependencies">​</a></h3>
<p>Add <code>flutter_background_service</code> to your <code>pubspec.yaml</code>:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">dependencies</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">flutter_background_service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ^5.0.5 </span><span class="token comment" style="color:#999988;font-style:italic"># Use the latest compatible version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">sqlite_async</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ^0.6.0 </span><span class="token comment" style="color:#999988;font-style:italic"># Ensure this is present for database operations</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-generated-files-typical">3. Generated Files (Typical)<a href="#3-generated-files-typical" class="hash-link" aria-label="Direct link to 3. Generated Files (Typical)" title="Direct link to 3. Generated Files (Typical)">​</a></h3>
<ul>
<li><code>lib/database/providers/background_job_manager_provider.g.dart</code> (if generated
by Tether): Provides <code>backgroundJobManagerProvider</code>.</li>
<li>Database migration for <code>background_service_jobs</code> table.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-database-schema-background_service_jobs">4. Database Schema (<code>background_service_jobs</code>)<a href="#4-database-schema-background_service_jobs" class="hash-link" aria-label="Direct link to 4-database-schema-background_service_jobs" title="Direct link to 4-database-schema-background_service_jobs">​</a></h3>
<p>The system relies on a table like the following (based on <code>BackgroundJob</code>
model):</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> background_service_jobs </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id </span><span class="token keyword" style="color:#00009f">INTEGER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> AUTOINCREMENT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    job_key </span><span class="token keyword" style="color:#00009f">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    payload </span><span class="token keyword" style="color:#00009f">TEXT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">               </span><span class="token comment" style="color:#999988;font-style:italic">-- JSON-encoded job parameters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">-- &#x27;PENDING&#x27;, &#x27;RUNNING&#x27;, &#x27;COMPLETED&#x27;, &#x27;FAILED&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attempts </span><span class="token keyword" style="color:#00009f">INTEGER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_attempts </span><span class="token keyword" style="color:#00009f">INTEGER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    last_attempt_at </span><span class="token keyword" style="color:#00009f">TEXT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">-- ISO8601 timestamp (e.g., YYYY-MM-DDTHH:MM:SS.SSSZ)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    last_error </span><span class="token keyword" style="color:#00009f">TEXT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    priority </span><span class="token keyword" style="color:#00009f">INTEGER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Higher numbers = higher priority</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    created_at </span><span class="token keyword" style="color:#00009f">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">-- ISO8601 timestamp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    updated_at </span><span class="token keyword" style="color:#00009f">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- ISO8601 timestamp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="core-initialization-maindart">Core Initialization (<code>main.dart</code>)<a href="#core-initialization-maindart" class="hash-link" aria-label="Direct link to core-initialization-maindart" title="Direct link to core-initialization-maindart">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-background-service-initialization-callback">1. Background Service Initialization Callback<a href="#1-background-service-initialization-callback" class="hash-link" aria-label="Direct link to 1. Background Service Initialization Callback" title="Direct link to 1. Background Service Initialization Callback">​</a></h3>
<p>This function runs in the separate background isolate.</p>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ... imports ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import &#x27;package:example/database/database_native.dart&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (dart.library.html) &#x27;package:example/database/database_web.dart&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    as platform_db; // Conditional import for platform-specific DB setup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@pragma(&#x27;vm:entry-point&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Future&lt;void&gt; _myAppBackgroundInitialization(ServiceInstance service) async {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  WidgetsFlutterBinding.ensureInitialized();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DartPluginRegistrant.ensureInitialized(); // Important for platform channels</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  print(&quot;BackgroundService: MyAppBackgroundInitialization - Starting...&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Initialize database FOR THIS ISOLATE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final appDb = platform_db.getDatabase();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await appDb.initialize();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final SqliteConnection backgroundDbConnection = appDb.db as SqliteConnection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Set the database connection for the BackgroundService static methods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BackgroundService.setBackgroundDbConnection(backgroundDbConnection);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;BackgroundService: MyAppBackgroundInitialization - Background DB connection set.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Register your job handlers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BackgroundService.registerJobHandler(&#x27;dummyTask&#x27;, _dummyJobHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // BackgroundService.registerJobHandler(&#x27;sendEmail&#x27;, _sendEmailHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // BackgroundService.registerJobHandler(&#x27;processImage&#x27;, _processImageHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;BackgroundService: MyAppBackgroundInitialization - Job handlers registered.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } catch (e, s) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;BackgroundService: MyAppBackgroundInitialization - CRITICAL ERROR: $e\n$s&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service.stopSelf(); // Stop service if critical setup fails</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  print(&quot;BackgroundService: MyAppBackgroundInitialization - Complete.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-initialize-backgroundservice-in-main">2. Initialize <code>BackgroundService</code> in <code>main()</code><a href="#2-initialize-backgroundservice-in-main" class="hash-link" aria-label="Direct link to 2-initialize-backgroundservice-in-main" title="Direct link to 2-initialize-backgroundservice-in-main">​</a></h3>
<p>Call <code>BackgroundService.initialize</code> from your main isolate&#x27;s <code>main</code> function.</p>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// filepath: example/frontend/lib/main.dart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Future&lt;void&gt; main() async {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  WidgetsFlutterBinding.ensureInitialized();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Initialize other services (e.g., Supabase)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // await Supabase.initialize(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Initialize Background Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  await BackgroundService.initialize(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    appInitializationCallback: _myAppBackgroundInitialization,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initialNotificationTitle: &quot;My App Service&quot;, // Android notification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    initialNotificationContent: &quot;Performing background tasks...&quot;, // Android notification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Optional: notificationIconName: &#x27;ic_my_app_notification&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  print(&quot;Main Isolate: BackgroundService Configured.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ... (ensure default preferences, etc.) ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  runApp(const ProviderScope(child: MyApp()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="job-management">Job Management<a href="#job-management" class="hash-link" aria-label="Direct link to Job Management" title="Direct link to Job Management">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-defining-job-handlers">1. Defining Job Handlers<a href="#1-defining-job-handlers" class="hash-link" aria-label="Direct link to 1. Defining Job Handlers" title="Direct link to 1. Defining Job Handlers">​</a></h3>
<p>Job handlers are asynchronous functions that perform the actual work. They
receive the <code>ServiceInstance</code>, an optional <code>payload</code>, and the background
isolate&#x27;s <code>SqliteConnection</code>.</p>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@pragma(&#x27;vm:entry-point&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Future&lt;void&gt; _dummyJobHandler(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ServiceInstance service,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Map&lt;String, dynamic&gt;? payload,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SqliteConnection db, // Background isolate&#x27;s DB connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) async {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  print(&quot;BackgroundService: DummyJobHandler - Started with payload: $payload&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final message = payload?[&#x27;message&#x27;] ?? &#x27;No message&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Simulate work</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  for (int i = 0; i &lt; 5; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await Future.delayed(const Duration(seconds: 3));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;BackgroundService: DummyJobHandler - Working... ($message, step ${i+1})&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Optionally update Android foreground notification</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (service is AndroidServiceInstance &amp;&amp; await service.isForegroundService()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      service.setForegroundNotificationInfo(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        title: &quot;Dummy Task Progress&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        content: &quot;Processing: $message (Step ${i+1}/5)&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  print(&quot;BackgroundService: DummyJobHandler - Finished.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (service is AndroidServiceInstance &amp;&amp; await service.isForegroundService()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service.setForegroundNotificationInfo(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      title: &quot;Dummy Task Completed&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      content: &quot;Finished processing: $message&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Revert to default notification after a delay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Future.delayed(const Duration(seconds: 10), () {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      service.setForegroundNotificationInfo(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        title: &quot;My App Service&quot;, // Initial title</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        content: &quot;Performing background tasks...&quot;, // Initial content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-enqueuing-jobs-from-the-ui">2. Enqueuing Jobs from the UI<a href="#2-enqueuing-jobs-from-the-ui" class="hash-link" aria-label="Direct link to 2. Enqueuing Jobs from the UI" title="Direct link to 2. Enqueuing Jobs from the UI">​</a></h3>
<p>Use <code>BackgroundService.job()</code> from your UI isolate to add a job to the queue.
You must provide the UI isolate&#x27;s <code>SqliteConnection</code>.</p>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// filepath: example/frontend/lib/ui/tabs/background_tab.dart (Example Usage)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Future&lt;void&gt; _enqueueDummyTask() async {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ... (setState for loading state) ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Get the UI isolate&#x27;s database connection via Riverpod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final appDb = await ref.read(databaseProvider.future);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final uiDbConnection = appDb.db as SqliteConnection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final jobId = await BackgroundService.job(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      db: uiDbConnection, // UI isolate&#x27;s DB connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      jobKey: &#x27;dummyTask&#x27;, // Must match a registered handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      payload: {&#x27;message&#x27;: &#x27;Hello from UI at ${DateTime.now()}&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      priority: 1, // Optional priority</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      maxAttempts: 3, // Optional max attempts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (mounted) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (jobId != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ScaffoldMessenger.of(context).showSnackBar(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          SnackBar(content: Text(&#x27;Dummy task enqueued with ID: $jobId&#x27;)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Handle enqueue failure (e.g., handler not registered if service just restarted)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } catch (e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Handle error</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ... (setState to stop loading state) ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-backgroundjobmanager-ui-isolate">3. <code>BackgroundJobManager</code> (UI Isolate)<a href="#3-backgroundjobmanager-ui-isolate" class="hash-link" aria-label="Direct link to 3-backgroundjobmanager-ui-isolate" title="Direct link to 3-backgroundjobmanager-ui-isolate">​</a></h3>
<p>The <code>BackgroundJobManager</code> allows the UI to query and manage jobs from the
<code>background_service_jobs</code> table.</p>
<p><strong>Provider Setup:</strong> Your <code>background_job_manager_provider.g.dart</code> (or manually
created provider) should look like this:</p>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// filepath: example/frontend/lib/database/providers/background_job_manager_provider.g.dart</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import &#x27;package:flutter_riverpod/flutter_riverpod.dart&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import &#x27;package:sqlite_async/sqlite_async.dart&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import &#x27;package:tether_libs/background_service/background_service_manager.dart&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import &#x27;../database.dart&#x27;; // Your main database provider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">final backgroundJobManagerProvider = Provider&lt;BackgroundJobManager&gt;((ref) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final appDatabase = ref.watch(databaseProvider).requireValue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final dbConnection = appDatabase.db as SqliteConnection; // UI&#x27;s DB connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return BackgroundJobManager(db: dbConnection);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre></div></div>
<p><strong>Usage:</strong></p>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Accessing the manager in a widget</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">final jobManager = ref.watch(backgroundJobManagerProvider);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Get a job by ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">final job = await jobManager.getJobById(someJobId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Get pending jobs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">final pendingJobs = await jobManager.getJobsByStatus(BackgroundJobStatus.pending);</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ui-integration--status-monitoring">UI Integration &amp; Status Monitoring<a href="#ui-integration--status-monitoring" class="hash-link" aria-label="Direct link to UI Integration &amp; Status Monitoring" title="Direct link to UI Integration &amp; Status Monitoring">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="controlling-the-service">Controlling the Service<a href="#controlling-the-service" class="hash-link" aria-label="Direct link to Controlling the Service" title="Direct link to Controlling the Service">​</a></h3>
<p>The <code>BackgroundServiceTab</code> in the example demonstrates how to start, stop, and
check the status of the service:</p>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Start the service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">await BackgroundService.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Stop the service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">await BackgroundService.stop();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Check if running</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">final bool isRunning = await BackgroundService.isRunning();</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="displaying-job-status">Displaying Job Status<a href="#displaying-job-status" class="hash-link" aria-label="Direct link to Displaying Job Status" title="Direct link to Displaying Job Status">​</a></h3>
<p>Create Riverpod providers to stream job status updates:</p>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Provider to watch jobs by status (e.g., pending)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">final pendingJobsStreamProvider = StreamProvider&lt;List&lt;BackgroundJob&gt;&gt;((ref) async* {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final manager = ref.watch(backgroundJobManagerProvider);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Periodically poll for updates or use a more sophisticated notification mechanism</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // if your database supports it (e.g., SQLite update hooks via FFI).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // For simplicity, this example polls.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    yield await manager.getJobsByStatus(BackgroundJobStatus.pending, orderByCreation: &#x27;DESC&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await Future.delayed(const Duration(seconds: 5)); // Poll interval</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Provider to watch a specific job by ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">final jobStreamProvider = StreamProvider.family&lt;BackgroundJob?, int&gt;((ref, jobId) async* {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final manager = ref.watch(backgroundJobManagerProvider);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    yield await manager.getJobById(jobId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await Future.delayed(const Duration(seconds: 2));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre></div></div>
<p><strong>Widget Example:</strong></p>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class JobStatusDashboard extends ConsumerWidget {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Widget build(BuildContext context, WidgetRef ref) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final pendingJobsAsync = ref.watch(pendingJobsStreamProvider);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return pendingJobsAsync.when(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      data: (jobs) =&gt; jobs.isEmpty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ? Center(child: Text(&#x27;No pending jobs&#x27;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          : ListView.builder(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              itemCount: jobs.length,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              itemBuilder: (context, index) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                final job = jobs[index];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return ListTile(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  title: Text(&#x27;${job.jobKey} (ID: ${job.id})&#x27;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  subtitle: Text(&#x27;Status: ${job.status.name}, Attempts: ${job.attempts}&#x27;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  // ... more details</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      loading: () =&gt; Center(child: CircularProgressIndicator()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      error: (err, stack) =&gt; Center(child: Text(&#x27;Error: $err&#x27;)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-providercontainer-for-non-widget-scenarios-main-isolate">Using <code>ProviderContainer</code> for Non-Widget Scenarios (Main Isolate)<a href="#using-providercontainer-for-non-widget-scenarios-main-isolate" class="hash-link" aria-label="Direct link to using-providercontainer-for-non-widget-scenarios-main-isolate" title="Direct link to using-providercontainer-for-non-widget-scenarios-main-isolate">​</a></h2>
<p>Sometimes you need to interact with Riverpod providers (like <code>databaseProvider</code>
to get a <code>SqliteConnection</code> or <code>backgroundJobManagerProvider</code>) outside the
widget tree in your <strong>main UI isolate</strong>, for example, in a service class, a
utility function, or for testing. <code>ProviderContainer</code> is the solution for these
main-isolate scenarios.</p>
<p><strong>Important:</strong> You are responsible for disposing the <code>ProviderContainer</code> when
it&#x27;s no longer needed to prevent memory leaks.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-1-enqueuing-a-job-from-a-service-class-main-isolate">Example 1: Enqueuing a Job from a Service Class (Main Isolate)<a href="#example-1-enqueuing-a-job-from-a-service-class-main-isolate" class="hash-link" aria-label="Direct link to Example 1: Enqueuing a Job from a Service Class (Main Isolate)" title="Direct link to Example 1: Enqueuing a Job from a Service Class (Main Isolate)">​</a></h3>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// This service class runs in the main UI isolate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class MyBackgroundJobEnqueueService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final ProviderContainer _container; // Typically, this container would be passed in or be a long-lived one</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MyBackgroundJobEnqueueService(this._container);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Future&lt;void&gt; scheduleReportGeneration(String reportType) async {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // 1. Obtain the UI isolate&#x27;s database connection from the main container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      final appDatabase = await _container.read(databaseProvider.future);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      final SqliteConnection uiDbConnection = appDatabase.db as SqliteConnection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // 2. Enqueue the job</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      final jobId = await BackgroundService.job(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        db: uiDbConnection,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        jobKey: &#x27;generateReport&#x27;, // Ensure this handler is registered</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        payload: {&#x27;reportType&#x27;: reportType, &#x27;requestedBy&#x27;: &#x27;main_isolate_service&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      print(&#x27;Report generation job enqueued from Main Isolate Service with ID: $jobId&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      print(&#x27;Error in MyBackgroundJobEnqueueService enqueuing job: $e&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Dispose method might be needed if the container is scoped to this service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Usage (e.g., during app setup or from another main isolate service):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// final mainGlobalContainer = ProviderContainer(); // A longer-lived container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// final jobEnqueueService = MyBackgroundJobEnqueueService(mainGlobalContainer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// await jobEnqueueService.scheduleReportGeneration(&#x27;dailySummary&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Later, when appropriate: mainGlobalContainer.dispose();</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-2-reading-job-status-for-utilities-main-isolate">Example 2: Reading Job Status for Utilities (Main Isolate)<a href="#example-2-reading-job-status-for-utilities-main-isolate" class="hash-link" aria-label="Direct link to Example 2: Reading Job Status for Utilities (Main Isolate)" title="Direct link to Example 2: Reading Job Status for Utilities (Main Isolate)">​</a></h3>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// This utility function runs in the main UI isolate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Future&lt;void&gt; checkJobStatusUtility(int jobId) async {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final container = ProviderContainer(); // Create a temporary container for this utility</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final jobManager = container.read(backgroundJobManagerProvider);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final BackgroundJob? job = await jobManager.getJobById(jobId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (job != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      print(&#x27;Job $jobId Status (from Main Isolate Utility): ${job.status}, Attempts: ${job.attempts}&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      print(&#x27;Job $jobId not found (from Main Isolate Utility).&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } catch (e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&#x27;Error checking job status in Main Isolate Utility: $e&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    container.dispose(); // Dispose the temporary container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Usage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// await checkJobStatusUtility(123);</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-providercontainer-within-a-job-handler-background-isolate">Using <code>ProviderContainer</code> within a Job Handler (Background Isolate)<a href="#using-providercontainer-within-a-job-handler-background-isolate" class="hash-link" aria-label="Direct link to using-providercontainer-within-a-job-handler-background-isolate" title="Direct link to using-providercontainer-within-a-job-handler-background-isolate">​</a></h2>
<p>If a background job handler itself has complex internal logic or needs to manage
its own set of dependencies, you can create and use a <code>ProviderContainer</code>
<em>within that job handler</em>. This container will be <strong>local to the background
isolate and that specific job&#x27;s execution</strong>; it is <strong>not</strong> connected to your
main UI isolate&#x27;s <code>ProviderContainer</code>.</p>
<p>This pattern is useful for organizing code within the job handler, especially if
it calls multiple services or performs several distinct steps.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-job-handler-with-its-own-local-providercontainer">Example: Job Handler with its Own Local <code>ProviderContainer</code><a href="#example-job-handler-with-its-own-local-providercontainer" class="hash-link" aria-label="Direct link to example-job-handler-with-its-own-local-providercontainer" title="Direct link to example-job-handler-with-its-own-local-providercontainer">​</a></h3>
<p>Let&#x27;s imagine a job handler that needs to fetch data using a service and then
process it using another service, both of which might benefit from being managed
by Riverpod <em>within the job&#x27;s scope</em>.</p>
<div class="language-dart codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-dart codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Define services that might be used by the job handler.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// These would typically be in their own files.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class DataFetcherService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final SqliteConnection _db;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DataFetcherService(this._db);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Future&lt;List&lt;Map&lt;String, dynamic&gt;&gt;&gt; fetchData(String queryKey) async {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;BackgroundJob/DataFetcherService: Fetching data for &#x27;$queryKey&#x27; using ${_db.hashCode}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Simulate DB query using the background isolate&#x27;s DB connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await Future.delayed(const Duration(milliseconds: 500));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return [{&#x27;id&#x27;: 1, &#x27;data&#x27;: &#x27;Sample data for $queryKey&#x27;}];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class DataProcessorService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Future&lt;Map&lt;String, dynamic&gt;&gt; process(List&lt;Map&lt;String, dynamic&gt;&gt; rawData) async {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;BackgroundJob/DataProcessorService: Processing ${rawData.length} items.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await Future.delayed(const Duration(milliseconds: 300));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return {&#x27;processed_count&#x27;: rawData.length, &#x27;summary&#x27;: &#x27;Processed successfully&#x27;};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Define providers for these services, intended for the job&#x27;s local container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">final dataFetcherProvider = Provider&lt;DataFetcherService&gt;((ref) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // This provider would need access to the SqliteConnection.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // For this example, we&#x27;ll assume it&#x27;s made available to the container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // or the service is constructed directly with it.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // This is a simplified example; in reality, you&#x27;d pass the &#x27;db&#x27; from the handler.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  throw UnimplementedError(&quot;dataFetcherProvider needs db. Override or pass directly.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">final dataProcessorProvider = Provider&lt;DataProcessorService&gt;((ref) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return DataProcessorService();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// The job handler itself</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@pragma(&#x27;vm:entry-point&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Future&lt;void&gt; _complexDataProcessingJobHandler(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ServiceInstance service,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Map&lt;String, dynamic&gt;? payload,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SqliteConnection db, // This is the background isolate&#x27;s DB connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) async {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final queryKey = payload?[&#x27;queryKey&#x27;] as String?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (queryKey == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw ArgumentError(&quot;queryKey is required in payload for complexDataProcessingJobHandler.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  print(&quot;BackgroundJob/ComplexHandler: Started for queryKey &#x27;$queryKey&#x27;. DB: ${db.hashCode}&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Create a ProviderContainer local to this job&#x27;s execution</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  final jobContainer = ProviderContainer(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    overrides: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // Override dataFetcherProvider to use the &#x27;db&#x27; connection passed to the handler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      dataFetcherProvider.overrideWithValue(DataFetcherService(db)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Access services through the local container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final fetcher = jobContainer.read(dataFetcherProvider);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final processor = jobContainer.read(dataProcessorProvider);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final rawData = await fetcher.fetchData(queryKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final processedResult = await processor.process(rawData);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;BackgroundJob/ComplexHandler: Successfully processed data for &#x27;$queryKey&#x27;. Result: $processedResult&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Example: Store result or update status using the &#x27;db&#x27; connection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await db.execute(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;INSERT INTO job_results (job_key, query_key, result, processed_at) VALUES (?, ?, ?, ?)&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        [&#x27;complexDataProcessing&#x27;, queryKey, jsonEncode(processedResult), DateTime.now().toIso8601String()]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } catch (e, s) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;BackgroundJob/ComplexHandler: Error processing data for &#x27;$queryKey&#x27;: $e\n$s&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw e; // Re-throw to allow BackgroundService to handle failure/retry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jobContainer.dispose(); // Crucial: Dispose the local container</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print(&quot;BackgroundJob/ComplexHandler: Finished for queryKey &#x27;$queryKey&#x27;.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Remember to register this handler in _myAppBackgroundInitialization:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// BackgroundService.registerJobHandler(&#x27;complexDataProcessing&#x27;, _complexDataProcessingJobHandler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// And to enqueue it from the UI isolate:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// await BackgroundService.job(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//   db: uiDbConnection,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//   jobKey: &#x27;complexDataProcessing&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">//   payload: {&#x27;queryKey&#x27;: &#x27;userActivity&#x27;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// );</span><br></span></code></pre></div></div>
<p><strong>Key points for using <code>ProviderContainer</code> inside a job handler:</strong></p>
<ul>
<li><strong>Isolation</strong>: The <code>jobContainer</code> is entirely separate from your UI&#x27;s main
<code>ProviderContainer</code>. It cannot access providers or states from the UI isolate.</li>
<li><strong>Dependency Injection</strong>: It&#x27;s useful for managing dependencies <em>within</em> the
complex logic of a single job handler.</li>
<li><strong>Database Connection</strong>: The background isolate&#x27;s <code>SqliteConnection</code> (<code>db</code>
parameter to the handler) should be passed to any services within this local
container that need database access. This can be done via constructor
injection or by overriding providers as shown.</li>
<li><strong>Lifecycle</strong>: Create the <code>jobContainer</code> at the beginning of the handler and
<strong>always <code>dispose()</code> it in a <code>finally</code> block</strong> to prevent resource leaks
within the background isolate.</li>
<li><strong>Simplicity</strong>: For simpler job handlers, creating a local <code>ProviderContainer</code>
might be overkill. Direct instantiation of necessary helper classes might be
more straightforward.</li>
</ul>
<p><strong>Note on <code>ProviderContainer</code> Lifecycle (General):</strong></p>
<ul>
<li>If you create a <code>ProviderContainer</code> for a short-lived operation (like a single
function call, a test, or within a job handler), dispose it in a <code>finally</code>
block.</li>
<li>If a service class in the main isolate uses a <code>ProviderContainer</code>, the
container might be passed in or created by the service. Its disposal should
align with the service&#x27;s lifecycle.</li>
<li>Avoid creating many short-lived containers frequently in performance-critical
paths. For UI, always use <code>ConsumerWidget</code>, <code>ConsumerStatefulWidget</code>, or <code>ref</code>
from hooks.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="error-handling--retries">Error Handling &amp; Retries<a href="#error-handling--retries" class="hash-link" aria-label="Direct link to Error Handling &amp; Retries" title="Direct link to Error Handling &amp; Retries">​</a></h2>
<ul>
<li><strong>Job Handlers</strong>: If a job handler throws an exception, the
<code>BackgroundService</code> catches it, marks the job as <code>FAILED</code> in the database, and
records the error message in <code>last_error</code>.</li>
<li><strong>Retries</strong>: The service automatically attempts to retry failed jobs up to
<code>max_attempts</code> times. The <code>attempts</code> count is incremented.</li>
<li><strong>No Retry</strong>: If an error is considered non-recoverable, the job handler can
catch it and simply return without re-throwing, or throw a specific exception
type that your <code>BackgroundService</code> modification might handle to prevent
retries.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="best-practices">Best Practices<a href="#best-practices" class="hash-link" aria-label="Direct link to Best Practices" title="Direct link to Best Practices">​</a></h2>
<ul>
<li><strong>Idempotent Jobs</strong>: Design job handlers to be idempotent where possible,
meaning running them multiple times with the same input produces the same
result without unintended side effects.</li>
<li><strong>Granular Jobs</strong>: Break down complex tasks into smaller, manageable jobs.</li>
<li><strong>Payloads</strong>: Keep payloads concise and include all necessary information for
the job to execute independently.</li>
<li><strong>Error Reporting</strong>: Implement robust error logging within job handlers and
consider reporting critical failures to an external monitoring service.</li>
<li><strong>Resource Management</strong>: Ensure job handlers clean up any resources they use
(e.g., temporary files).</li>
<li><strong>Background DB Connection</strong>: Always use the <code>SqliteConnection</code> provided to
the job handler for database operations within the background isolate. The UI
isolate uses its own connection (typically via <code>databaseProvider</code>).</li>
<li><strong>Testing</strong>: Thoroughly test job handlers and the overall background
processing flow.</li>
</ul>
<p>This documentation provides a comprehensive guide to using the Background
Service unit in your Flutter Tether application, leveraging its persistence,
background execution</p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/flutter_tether/additional_features/user_preferences_manager"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">User Preferences Manager</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#setup--configuration" class="table-of-contents__link toc-highlight">Setup &amp; Configuration</a><ul><li><a href="#1-enable-in-configuration-tetheryaml" class="table-of-contents__link toc-highlight">1. Enable in Configuration (<code>tether.yaml</code>)</a></li><li><a href="#2-install-dependencies" class="table-of-contents__link toc-highlight">2. Install Dependencies</a></li><li><a href="#3-generated-files-typical" class="table-of-contents__link toc-highlight">3. Generated Files (Typical)</a></li><li><a href="#4-database-schema-background_service_jobs" class="table-of-contents__link toc-highlight">4. Database Schema (<code>background_service_jobs</code>)</a></li></ul></li><li><a href="#core-initialization-maindart" class="table-of-contents__link toc-highlight">Core Initialization (<code>main.dart</code>)</a><ul><li><a href="#1-background-service-initialization-callback" class="table-of-contents__link toc-highlight">1. Background Service Initialization Callback</a></li><li><a href="#2-initialize-backgroundservice-in-main" class="table-of-contents__link toc-highlight">2. Initialize <code>BackgroundService</code> in <code>main()</code></a></li></ul></li><li><a href="#job-management" class="table-of-contents__link toc-highlight">Job Management</a><ul><li><a href="#1-defining-job-handlers" class="table-of-contents__link toc-highlight">1. Defining Job Handlers</a></li><li><a href="#2-enqueuing-jobs-from-the-ui" class="table-of-contents__link toc-highlight">2. Enqueuing Jobs from the UI</a></li><li><a href="#3-backgroundjobmanager-ui-isolate" class="table-of-contents__link toc-highlight">3. <code>BackgroundJobManager</code> (UI Isolate)</a></li></ul></li><li><a href="#ui-integration--status-monitoring" class="table-of-contents__link toc-highlight">UI Integration &amp; Status Monitoring</a><ul><li><a href="#controlling-the-service" class="table-of-contents__link toc-highlight">Controlling the Service</a></li><li><a href="#displaying-job-status" class="table-of-contents__link toc-highlight">Displaying Job Status</a></li></ul></li><li><a href="#using-providercontainer-for-non-widget-scenarios-main-isolate" class="table-of-contents__link toc-highlight">Using <code>ProviderContainer</code> for Non-Widget Scenarios (Main Isolate)</a><ul><li><a href="#example-1-enqueuing-a-job-from-a-service-class-main-isolate" class="table-of-contents__link toc-highlight">Example 1: Enqueuing a Job from a Service Class (Main Isolate)</a></li><li><a href="#example-2-reading-job-status-for-utilities-main-isolate" class="table-of-contents__link toc-highlight">Example 2: Reading Job Status for Utilities (Main Isolate)</a></li></ul></li><li><a href="#using-providercontainer-within-a-job-handler-background-isolate" class="table-of-contents__link toc-highlight">Using <code>ProviderContainer</code> within a Job Handler (Background Isolate)</a><ul><li><a href="#example-job-handler-with-its-own-local-providercontainer" class="table-of-contents__link toc-highlight">Example: Job Handler with its Own Local <code>ProviderContainer</code></a></li></ul></li><li><a href="#error-handling--retries" class="table-of-contents__link toc-highlight">Error Handling &amp; Retries</a></li><li><a href="#best-practices" class="table-of-contents__link toc-highlight">Best Practices</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Chad Specter.</div></div></div></footer></div>
</body>
</html>